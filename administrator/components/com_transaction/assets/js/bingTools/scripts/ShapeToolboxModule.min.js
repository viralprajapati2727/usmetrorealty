var ShapeToolboxModule=function(C,B){var E=C,v=null,Q=null,W=[],L=[],w=null,U=[],J=null,aa=null,K=null,t=null,I=null,p=false,s="",h=null,M=null,ab=null,d=null,t=null,O=null,j=null,x=null,l=null,N=null,Y=null,f=Microsoft.Maps;var r="1.1";var T={shapeType:"polyline",targetLayer:E.entities,maskStrokeColor:new Microsoft.Maps.Color(200,100,100,100),maskFillColor:new Microsoft.Maps.Color(0,0,0,0),maskStrokeThickness:2,maskStrokeDashArray:"2 2",shapeStrokeColor:new Microsoft.Maps.Color(200,0,0,200),shapeStrokeThickness:2,shapeFillColor:new Microsoft.Maps.Color(100,0,100,0),toolBarPolygonIcon:"images/polygonIcon.png",toolBarPolygonHoverIcon:"images/polygonHoverIcon.png",toolBarPolygonActiveIcon:"images/polygonActiveIcon.png",toolBarPolylineIcon:"images/polylineIcon.png",toolBarPolylineHoverIcon:"images/polylineHoverIcon.png",toolBarPolylineActiveIcon:"images/polylineActiveIcon.png",toolBarPushPinIcon:"images/pushpinIcon.png",toolBarPushPinHoverIcon:"images/pushpinHoverIcon.png",toolBarPushPinActiveIcon:"images/pushpinActiveIcon.png",toolBarRectangleIcon:"images/rectangleIcon.png",toolBarRectangleHoverIcon:"images/rectangleHoverIcon.png",toolbarRectangleActiveIcon:"images/rectangleActiveIcon.png",toolbarCircleIcon:"images/circleIcon.png",toolbarCircleHoverIcon:"images/circleHoverIcon.png",toolbarCircleActiveIcon:"images/circleActiveIcon.png",dragHandleImage:"images/DragHandleWhite.gif",dragHandleImageActive:"images/DragHandleGreen.gif",dragHandleImageHeight:10,dragHandleImageWidth:10,dragHandleImageAnchor:new Microsoft.Maps.Point(5,5),shapeMaskStrokeColor:new Microsoft.Maps.Color(200,100,100,100),shapeMaskFillColor:new Microsoft.Maps.Color(0,0,0,0),shapeMaskStrokeThickness:2,shapeMaskStrokeDashArray:"2 2"};if(B){X(B)}var u=C.getRootElement(),D=u.offsetParent.id,e=D+"_ToolBarContainer";(function(){var ad=document.createElement("div");ad.id=e;ad.style.top="0px";ad.style.right="0px";ad.style.position="absolute";ad.style.width="140px";ad.style.height="28px";ad.style.backgroundColor="rgb(250, 247, 245)";ad.style.border="1px solid #a0a0a0";ad.style.visibility="hidden";var ac=function(ah,ag,am,al,ak,aj){var ai=new Image();ai.src=ag;ai=new Image();ai.src=am;ai=new Image();ai.src=ak;var af='<div id="'+e+'_{0}Button" style="width: 28px; height: 29px; background-image: url({1}); background-repeat: no-repeat; float:left;" onclick="toolBarClick(this, \'{2}\', { shapeType: \'{3}\' });" onmouseover="changeToolBarBackground(this, \'{4}\');" onmouseout="changeToolBarBackground(this, \'{5}\');"></div>';return af.replace(/\{0\}/g,ah).replace(/\{1\}/g,ag).replace(/\{2\}/g,am).replace(/\{3\}/g,al).replace(/\{4\}/g,ak).replace(/\{5\}/g,aj)};s+=ac("Polyline",T.toolBarPolylineIcon,T.toolBarPolylineActiveIcon,"polyline",T.toolBarPolylineHoverIcon,T.toolBarPolylineIcon);s+=ac("Polygon",T.toolBarPolygonIcon,T.toolBarPolygonActiveIcon,"polygon",T.toolBarPolygonHoverIcon,T.toolBarPolygonIcon);s+=ac("Rectangle",T.toolBarRectangleIcon,T.toolbarRectangleActiveIcon,"rectangle",T.toolBarRectangleHoverIcon,T.toolBarRectangleIcon);s+=ac("Circle",T.toolbarCircleIcon,T.toolbarCircleActiveIcon,"circle",T.toolbarCircleHoverIcon,T.toolbarCircleIcon);s+=ac("PushPin",T.toolBarPushPinIcon,T.toolBarPushPinActiveIcon,"pushpin",T.toolBarPushPinHoverIcon,T.toolBarPushPinIcon);ad.innerHTML=s;u.parentNode.appendChild(ad);ae(".BM_Module_DragHandle","{ cursor:pointer; }");function ae(af,ai){if(!document.styleSheets){return}if(document.getElementsByTagName("head").length==0){return}var ah;var ag;if(document.styleSheets.length>0){for(i=0;i<document.styleSheets.length;i++){if(document.styleSheets[i].disabled){continue}var ak=document.styleSheets[i].media;ag=typeof ak;if(ag=="string"){if(ak==""||(ak.indexOf("screen")!=-1)){styleSheet=document.styleSheets[i]}}else{if(ag=="object"){if(ak.mediaText==""||(ak.mediaText.indexOf("screen")!=-1)){styleSheet=document.styleSheets[i]}}}if(typeof styleSheet!="undefined"){break}}}if(typeof styleSheet=="undefined"){var aj=document.createElement("style");aj.type="text/css";document.getElementsByTagName("head")[0].appendChild(aj);for(i=0;i<document.styleSheets.length;i++){if(document.styleSheets[i].disabled){continue}styleSheet=document.styleSheets[i]}var ak=styleSheet.media;ag=typeof ak}if(ag=="string"){for(i=0;i<styleSheet.rules.length;i++){if(styleSheet.rules[i].selectorText.toLowerCase()==af.toLowerCase()){styleSheet.rules[i].style.cssText=ai;return}}styleSheet.addRule(af,ai)}else{if(ag=="object"){for(i=0;i<styleSheet.cssRules.length;i++){if(styleSheet.cssRules[i].selectorText.toLowerCase()==af.toLowerCase()){styleSheet.cssRules[i].style.cssText=ai;return}}styleSheet.insertRule(af+"{"+ai+"}",0)}}}})();function S(){if(T.targetLayer.toString()!="[EntityCollection]"){throw"Module can only be used to add shapes to an entity collection."}I=f.Events.addHandler(E,"dblclick",k);K=f.Events.addHandler(E,"click",y);t=f.Events.addHandler(E,"keypress",a);F("crosshair");U=[new f.Location(0,0),new f.Location(0,0)];w=new f.Polyline(U,{strokeColor:T.maskStrokeColor,strokeThickness:T.maskStrokeThickness,strokeDashArray:T.maskStrokeDashArray});W=[];p=true}function G(){if(Q.toString()!="[Polyline]"&&Q.toString()!="[Polygon]"&&Q.toString()!="[AdvancedShapes.Polygon]"){throw"Module can only be used for shapes that are polylines or polygons"}L=[];L=Q.getLocations();if(d!=null){C.entities.remove(d);d=null}d=new f.EntityCollection();var ad={fillColor:T.shapeMaskFillColor,strokeColor:T.shapeMaskStrokeColor,strokeThickness:T.shapeMaskStrokeThickness,strokeDashArray:T.shapeMaskStrokeDashArray};switch(Q.toString()){case"[Polyline]":ab=new f.Polyline(L,ad);break;case"[Polygon]":case"[AdvancedShapes.Polygon]":ab=new f.Polygon(L,ad);break}var ae=1;if(Q.toString()=="[Polygon]"||Q.toString()=="[AdvancedShapes.Polygon]"){ae=2}ad={draggable:true,icon:T.dragHandleImage,height:T.dragHandleImageHeight,width:T.dragHandleImageWidth,anchor:T.dragHandleImageAnchor,typeName:"BM_Module_DragHandle"};switch(h.toLowerCase()){case"polyline":case"polygon":case"rectangle":for(i=0;i<=(L.length-ae);i++){var ac=new f.Pushpin(L[i],ad);R(ac)}break;case"circle":var ac=new f.Pushpin(L[26],ad);R(ac);break}d.push(ab);C.entities.push(d);t=f.Events.addHandler(E,"keypress",c);u.onkeyup=c}function R(ac){f.Events.addHandler(ac,"dragstart",b);f.Events.addHandler(ac,"drag",z);f.Events.addHandler(ac,"dragend",H);f.Events.addHandler(ac,"mouseover",V);f.Events.addHandler(ac,"mouseout",Z);d.push(ac)}function y(ad){J=E.tryPixelToLocation(new f.Point(ad.getX(),ad.getY()));W.push(J);U[0]=J;switch(T.shapeType.toLowerCase()){case"pushpin":T.targetLayer.push(new f.Pushpin(J,{draggable:true}));F("crosshair");break;case"polygon":case"polyline":case"rectangle":case"circle":switch(W.length){case 1:U[1]=J;T.targetLayer.push(w);aa=f.Events.addHandler(E,"mousemove",n);break;case 2:var ac={strokeColor:T.shapeStrokeColor,strokeThickness:T.shapeStrokeThickness,fillColor:T.shapeFillColor};switch(T.shapeType.toLowerCase()){case"polyline":v=new f.Polyline(W,ac);v.shapeType=T.shapeType;T.targetLayer.push(v);break;case"polygon":v=new f.Polygon(W,ac);v.shapeType=T.shapeType;T.targetLayer.push(v);break;case"rectangle":case"circle":W=U;W.shift();v=new f.Polygon(W,ac);v.shapeType=T.shapeType;T.targetLayer.push(v);P();break;default:throw'Shape type must be "polygon" or "polyline".'}break;default:w.setLocations(U);v.setLocations(W);break}break}ad.handled=true}function n(ac){F("crosshair");_tempLocation=E.tryPixelToLocation(new f.Point(ac.getX(),ac.getY()));switch(T.shapeType.toLowerCase()){case"rectangle":if(U.length==2){U.push(_tempLocation);U.push(_tempLocation);U.push(U[0])}U[2]=_tempLocation;U[1]=new f.Location(U[0].latitude,U[2].longitude);U[3]=new f.Location(U[2].latitude,U[0].longitude);break;case"circle":distance=A(W[0],_tempLocation);U=m(W[0].latitude,W[0].longitude,distance);break;default:U[1]=_tempLocation;break}w.setLocations(U);ac.handled=true}function F(ac){u.style.cursor=ac}function V(ac){ac.target.setOptions({icon:T.dragHandleImageActive})}function Z(ac){ac.target.setOptions({icon:T.dragHandleImage})}function b(ad){var ac=ad.entity.getLocation();for(i=0;i<=(L.length-1);i++){if(ac==L[i]){M=i;break}}switch(h.toLowerCase()){case"circle":locs=Q.getLocations();O=g(locs[17],locs[35]);break;case"rectangle":if(L.length==4){L.push(W[0])}switch(M){case 0:x=1;j=2;l=3;break;case 1:x=2;j=3;l=0;break;case 2:x=1;j=0;l=3;break;case 3:x=2;j=1;l=0;break}break;default:break}}function z(ac){var ad=ac.entity.getLocation();switch(h.toLowerCase()){case"circle":L=m(O.latitude,O.longitude,A(O,ad));ab.setLocations(L);break;case"polyline":case"polygon":L[M]=ad;if(M==0&&(Q.toString()=="[Polygon]"||Q.toString()=="[AdvancedShapes.Polygon]")){L[L.length-1]=ad}ab.setLocations(L);break;case"rectangle":L[M]=ad;L[x]=new f.Location(L[j].latitude,L[M].longitude);L[l]=new f.Location(L[M].latitude,L[j].longitude);L[L.length-1]=L[0];ab.setLocations(L);d.get(x).setLocation(L[x]);d.get(j).setLocation(L[j]);d.get(l).setLocation(L[l]);break;default:break}}function H(ac){Q.setLocations(L)}function a(ac){if(o(ac)=="27"){P()}ac.handled=true}function c(ac){if(o(ac)=="27"){q()}else{if(o(ac)=="46"){T.targetLayer.remove(Q);q()}}if(ac){ac.handled=true}}function o(ac){if(window.event){return window.event.keyCode}else{if(ac.keyCode){return ac.keyCode}else{if(ac.which){return ac.which}}}}function k(ac){P();ac.handled=true}function P(){if(v&&(v.toString()=="[Polygon]"||Q.toString()=="[AdvancedShapes.Polygon]")){if(W[W.length-1].toString()==W[W.length-2].toString()){W.pop()}W.push(W[0]);v.setLocations(W)}f.Events.addHandler(v,"click",function(ac){edit(ac.target)});T.targetLayer.remove(w);v=null;F("url(images/grab.cur)");f.Events.removeHandler(K);f.Events.removeHandler(aa);f.Events.removeHandler(t);f.Events.removeHandler(I);document.getElementById(e+"_PolylineButton").style.backgroundImage="url("+T.toolBarPolylineIcon+")";document.getElementById(e+"_PolygonButton").style.backgroundImage="url("+T.toolBarPolygonIcon+")";document.getElementById(e+"_RectangleButton").style.backgroundImage="url("+T.toolBarRectangleIcon+")";document.getElementById(e+"_CircleButton").style.backgroundImage="url("+T.toolbarCircleIcon+")";document.getElementById(e+"_PushPinButton").style.backgroundImage="url("+T.toolBarPushPinIcon+")";p=false;edit.handled=true}function q(){f.Events.removeHandler(t);u.onkeyup=null;C.entities.remove(d);d=null;Q=null;edit.handled=true}function X(ac){for(optionName in ac){T[optionName]=ac[optionName]}}function A(al,ak){var ae=al.latitude,ah=al.longitude,ad=ak.latitude,ag=ak.longitude;var af=6371/1.609344;var ai=(ad-ae).toRad(),ac=(ag-ah).toRad();ae=ae.toRad(),ad=ad.toRad();var aj=Math.sin(ai/2)*Math.sin(ai/2)+Math.cos(ae)*Math.cos(ad)*Math.sin(ac/2)*Math.sin(ac/2);return af*2*Math.atan2(Math.sqrt(aj),Math.sqrt(1-aj))}function g(ae,af){lat1=ae.latitude.toRad();lon1=ae.longitude.toRad();lat2=af.latitude.toRad();var ad=(af.longitude-ae.longitude).toRad();var ac=Math.cos(lat2)*Math.cos(ad),ag=Math.cos(lat2)*Math.sin(ad);lat3=Math.atan2(Math.sin(lat1)+Math.sin(lat2),Math.sqrt((Math.cos(lat1)+ac)*(Math.cos(lat1)+ac)+ag*ag));lon3=lon1+Math.atan2(ag,Math.cos(lat1)+ac);lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI;return new f.Location(lat3.toDeg(),lon3.toDeg())}function m(ad,ae,aj){var ah=[],ag=ad.toRad(),ai=ae.toRad(),ak=aj/3956;for(var am=0;am<=360;am+=10){var af=(am/90)*Math.PI/2,al=Math.asin(Math.sin(ag)*Math.cos(ak)+Math.cos(ag)*Math.sin(ak)*Math.cos(af)),ac;al=al.toDeg();if(Math.cos(ag)==0){ac=ae}else{ac=((ai-Math.asin(Math.sin(af)*Math.sin(ak)/Math.cos(ag))+Math.PI)%(2*Math.PI))-Math.PI}ac=ac.toDeg();ah.push(new f.Location(al,ac))}return ah}this.dispose=function(){P()};this.version=function(){return r};this.show=function(){document.getElementById(e).style.visibility="visible"};this.hide=function(){document.getElementById(e).style.visibility="hidden"};this.setOptions=function(ac){X(ac)};draw=function(ac){if(p){P();changeToolBarBackground(N,Y)}q();X(ac);S()};edit=function(ac){if(ac.shapeType!=null){Q=ac;h=ac.shapeType;G()}};changeToolBarBackground=function(ac,ad){if(!p){ac.style.backgroundImage="url("+ad+")"}};toolBarClick=function(ad,ae,ac){q();if(p&&(ad==N)){P()}else{N=ad;Y=ae;changeToolBarBackground(N,Y);draw(ac)}}};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.toDeg=function(){return this*180/Math.PI};Microsoft.Maps.moduleLoaded("ShapeToolboxModule");