jQuery(document).ready(function(t){const a={};function _(a){t(".acym__automation__trigger__droppable__"+a).draggable({cursor:"dragging",revert:function(a){if(!a)return t(".acym__automation__droppable__drag").remove(),!0},revertDuration:300,start:function(_,e){t(".acym__automation__user-trigger__"+a).append('<div class="acym__automation__droppable__drag margin-top-1">'+t(e.helper).html()+"</div>")}}),t(".acym__automation__droppable__"+a).droppable({drop:function(_,o){t(this).find(".acym__automation__drag-here-text").remove(),t(".acym__automation__user-trigger__"+a+" .acym__automation__droppable__trigger").length>0&&t(".acym__automation__user-trigger__"+a).append('<div class="acym_trigger_delimiter">'+ACYM_JS_TXT.ACYM_OR+"</div>"),t(".acym__automation__user-trigger__"+a).append('<div class="acym__automation__droppable__trigger margin-top-1"><div class="acym__automation__one__trigger">'+t(o.helper).html()+'</div><i data-trigger-show="'+t(o.helper).attr("data-trigger")+'" class="acymicon-close acym__color__red acym__automation__delete__trigger cursor-pointer"></i></div>'),t(".acym__automation__droppable__drag").remove(),t(".acym__automation__all-trigger__"+a).append('<div class="acym__automation__trigger__droppable__'+a+' margin-top-1 cell" style="display: none" data-trigger="'+t(o.helper).attr("data-trigger")+'">'+t(o.helper).html()+"</div>"),t(o.helper).remove(),e(a),i(a)}})}function e(a){t(".acym__automation__user-trigger__"+a+" [data-class]").each(function(){t(this).addClass(t(this).attr("data-class")),t(this).removeAttr("data-class")}),acym_helperSelect2.setSelect2(),t(".acym__automation__user-trigger__"+a+" [name]").each(function(){t(this).attr("name").includes("stepAutomation")||t(this).attr("name","stepAutomation"+t(this).attr("name"))})}function i(a){t(".acym__automation__delete__trigger").off("click").on("click",function(){$container=t(this).closest(".acym__automation__droppable__trigger"),$previousDelimiter=$container.prev(".acym_trigger_delimiter"),$previousDelimiter.length?$previousDelimiter.remove():$container.next(".acym_trigger_delimiter").remove(),t("[data-trigger="+t(this).attr("data-trigger-show")+"]").show(),$container.remove(),_(a)})}function o(a){var _=t("#acym__automation__condition__"+a+"__options");if(_.length){var e=JSON.parse(_.val());t(".acym__automation__select__"+a+"__condition").off("change").on("change",function(){var a=t("#acym__automation__conditions__count__and");a.val(parseInt(a.val())+1),t(this).parent().parent().find(".acym__automation__inserted__condition").remove();var _=e[t(this).val()].replace(/__numor__/g,t(this).closest(".acym__automation__group__condition").attr("data-condition-number"));_=_.replace(/__numand__/g,a.val()),t(this).parent().after('<div data-and="'+a.val()+'" class="cell grid-x grid-margin-x grid-margin-y acym__automation__inserted__condition margin-top-1 margin-left-2">'+_+"</div>"),acym_helperSelect2.setSelect2(),acym_helperDatePicker.setDatePickerGlobal(),t(".switch-label").off("click").on("click",function(){var a=t('input[data-switch="'+t(this).attr("for")+'"]');a.attr("value",1-a.attr("value"))});var i=t(this).closest(".acym__automation__one__condition").find(".acym__automation__conditions__operator__dropdown"),o=t(this).closest(".acym__automation__one__condition").find(".acym__automation__conditions__fields__dropdown");i.on("change",function(){o.trigger("change")}),o.on("change",function(){var a=t(this).closest(".acym__automation__inserted__condition"),_=a.find('[data-condition-field="'+t(this).val()+'"]'),e=a.find(".acym__automation__conditions__fields__select"),o=a.find(".acym__automation__condition__regular-field");_.length>0&&("="===i.val()||"!="===i.val())?(o.attr("name",o.attr("name").replace("acym_condition","")).hide(),e.each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_condition","")),t(this).closest(".acym__automation__one-field").hide()}),-1===_.attr("name").indexOf("acym_condition")&&_.attr("name","acym_condition"+_.attr("name")),_.closest(".acym__automation__one-field").show()):(-1===o.attr("name").indexOf("acym_condition")&&o.attr("name","acym_condition"+o.attr("name")),e.length>0&&e.each(function(){t(this).attr("name",t(this).attr("name").replace("acym_condition","")),t(this).closest(".acym__automation__one-field").hide()}),o.show())}).trigger("change"),t(document).foundation(),t(".reveal-overlay").appendTo("#acym_form"),c()})}}function n(a){var _=t("#acym__automation__filter__"+a+"__options");if(_.length){var e=JSON.parse(_.val());t(".acym__automation__select__"+a+"__filter").off("change").on("change",function(){var _=t("#acym__automation__filters__count__and");_.val(parseInt(_.val())+1),t(this).parent().parent().find(".acym__automation__inserted__filter").remove();var i=e[t(this).val()].replace(/__numor__/g,t(this).closest(".acym__automation__group__filter").attr("data-filter-number"));i=i.replace(/__numand__/g,_.val()),t(this).parent().after('<div data-and="'+_.val()+'" class="cell grid-x grid-margin-x grid-margin-y acym__automation__inserted__filter margin-top-1 margin-left-2"><span class="countresults margin-bottom-1" id="results_'+_.val()+'"></span>'+i+"</div>"),acym_helperSelect2.setSelect2(),acym_helperDatePicker.setDatePickerGlobal(),t(".switch-label").off("click").on("click",function(){var a=t('input[data-switch="'+t(this).attr("for")+'"]');a.attr("value",1-a.attr("value"))});var o=t(this).closest(".acym__automation__one__filter").find(".acym__automation__filters__operator__dropdown"),n=t(this).closest(".acym__automation__one__filter").find(".acym__automation__filters__fields__dropdown");o.on("change",function(){n.trigger("change")}),n.on("change",function(){var a=t(this).closest(".acym__automation__inserted__filter"),_=a.find('[data-filter-field="'+t(this).val()+'"]'),e=a.find(".acym__automation__filters__fields__select"),i=a.find(".acym__automation__filter__regular-field");_.length>0&&("="===o.val()||"!="===o.val())?(i.attr("name",i.attr("name").replace("acym_action","")).hide(),e.each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),-1===_.attr("name").indexOf("acym_action")&&_.attr("name","acym_action"+_.attr("name")),_.closest(".acym__automation__one-field").show()):(-1===i.attr("name").indexOf("acym_action")&&i.attr("name","acym_action"+i.attr("name")),e.length>0&&e.each(function(){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),i.show())}).trigger("change"),"classic"===a&&(t(this).closest(".acym__automation__one__filter.acym__automation__one__filter__classic").find(".acym__automation__inserted__filter input, .acym__automation__inserted__filter select").on("change",function(){t.reloadCounters(this)}),0==t(this).val()?d(t(this).closest(".acym__automation__group__filter")):t.reloadCounters(t(this).closest(".acym__automation__one__filter.acym__automation__one__filter__classic").find(".acym__automation__inserted__filter input, .acym__automation__inserted__filter select"))),t(document).foundation(),t(".reveal-overlay").appendTo("#acym_form"),r()})}}function c(){o("classic"),o("user"),t(".acym__automation__add-condition").off("click").on("click",function(){if(0==t(this).closest(".acym__automation__group__condition").find(".acym__automation__one__condition").length){var a=t("#acym__automation__and__example").clone().removeAttr("id");a.find(".acym__automation__and").remove(),t(this).parent().before(a.show())}else t(this).parent().before(t("#acym__automation__and__example").clone().removeAttr("id").show());var _=t(this).parent().prev();_.addClass("acym__automation__one__condition__"+t(this).attr("data-condition-type")),_.find(".acym__automation__and__example__"+t(this).attr("data-condition-type")+"__select").show().find("select").addClass("acym__select").select2({theme:"foundation",width:"100%"}),c()}),t(".acym__automation__choose__condition").off("click").on("click",function(){t("#acym__automation__type-condition__input").val(t(this).attr("data-condition")),t(".selected-condition").removeClass("selected-condition"),t(this).addClass("selected-condition");var a=t(".acym__automation__condition__container");a.hide(),a.find('[name^="type_condition"]').each(function(a){t(this).attr("name",t(this).attr("name").replace("type_condition",""))});var _=t("#acym__automation__conditions__type__"+t(this).attr("data-condition"));_.show(),_.find('[name^="[conditions]"]').each(function(a){t(this).attr("name","type_condition"+t(this).attr("name"))})}),t(".acym__automation__conditions__or").off("click").on("click",function(){var a=t("#acym__automation__conditions__count__or");a.val(parseInt(a.val())+1),t(this).before(t("#acym__automation__or__example").html());var _=t(this).prev();_.attr("data-condition-number",a.val()),c(),_.find("button[data-condition-type]").attr("data-condition-type",t(this).attr("data-condition-type")).click(),"classic"===t(this).attr("data-condition-type")&&d(_)}),t(".acym__automation__delete__one__condition").off("click").on("click",function(){var a=t(this).closest(".acym__automation__group__condition");t(this).parent().parent().remove(),d(a)}),t(".acym__automation__delete__group__condition").off("click").on("click",function(){t(this).parent().parent().prev().remove(),t(this).parent().parent().remove()}),acym_helperDatePicker.setDatePickerGlobal(),acym_helperDatePicker.setRSDateChoice(),acym_helperSelect2.setAjaxSelect2(),m()}function r(){n("classic"),n("user"),t(".acym__automation__add-filter").off("click").on("click",function(){if(0==t(this).closest(".acym__automation__group__filter").find(".acym__automation__one__filter").length){var a=t("#acym__automation__and__example").clone().removeAttr("id");a.find(".acym__automation__and").remove(),t(this).parent().before(a.show())}else t(this).parent().before(t("#acym__automation__and__example").clone().removeAttr("id").show());var _=t(this).parent().prev();_.addClass("acym__automation__one__filter__"+t(this).attr("data-filter-type")),_.find(".acym__automation__and__example__"+t(this).attr("data-filter-type")+"__select").show().find("select").addClass("acym__select").select2({theme:"foundation",width:"100%"}),r()}),t(".acym__automation__choose__filter").off("click").on("click",function(){t("#acym__automation__type-filter__input").val(t(this).attr("data-filter")),t(".selected-filter").removeClass("selected-filter"),t(this).addClass("selected-filter");var a=t(".acym__automation__filter__container");a.hide(),a.find('[name^="acym_action"]').each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_action",""))});var _=t("#acym__automation__filters__type__"+t(this).attr("data-filter"));_.show(),_.find('[name^="[filters]"]').each(function(a){t(this).attr("name","acym_action"+t(this).attr("name"))})}),t(".acym__automation__filters__or").off("click").on("click",function(){var a=t("#acym__automation__filters__count__or");a.val(parseInt(a.val())+1),t(this).before(t("#acym__automation__or__example").html());var _=t(this).prev();_.attr("data-filter-number",a.val()),r(),_.find("button[data-filter-type]").attr("data-filter-type",t(this).attr("data-filter-type")).click(),"classic"===t(this).attr("data-filter-type")&&d(_)}),t(".acym__automation__delete__one__filter").off("click").on("click",function(){var a=t(this).closest(".acym__automation__group__filter");t(this).parent().parent().remove(),d(a)}),t(".acym__automation__delete__group__filter").off("click").on("click",function(){t(this).parent().parent().prev().remove(),t(this).parent().parent().remove()}),acym_helperDatePicker.setDatePickerGlobal(),acym_helperDatePicker.setRSDateChoice(),acym_helperSelect2.setAjaxSelect2(),m()}function m(){t("[acym-automation-reload]").each(function(){t(this).on("change",function(){let a=t(this).attr("acym-automation-reload"),_=JSON.parse(a),e={ctrl:"dynamics",task:"trigger",plugin:_.plugin,trigger:_.trigger};if(_.name&&(e.name=_.name,e.value=t('[name="'+_.name+'"]').val()),_.params)for(let[t,a]of Object.entries(_.params))e[t]=a;if(_.paramFields)for(let[a,i]of Object.entries(_.paramFields))e[a]=t('[name="'+i+'"]').val();t.ajax({type:"POST",url:ACYM_AJAX_URL,data:e,success:function(a){let e=t(_.change);e.html(a),acym_helperSelect2.setSelect2(),acym_helperSelect2.setAjaxSelect2(),acym_helperTooltip.setTooltip(),e.closest(".acym__automation__one__filter.acym__automation__one__filter__classic").find(".acym__automation__inserted__filter input, .acym__automation__inserted__filter select").on("change",function(){t.reloadCounters(e)})}})})})}function l(a,_){if(a.hasClass("acym_select2_ajax")){var e=a.attr("data-ctrl");e||(e="dynamics");var i=a.attr("data-task");i||(i="trigger");var o=ACYM_AJAX_URL+"&ctrl="+e+"&task="+i+"&id="+encodeURIComponent(_),n=a.attr("data-params"),c=acym_helper.parseJson(n);o+="&"+t.param(c),t.get(o,function(t){t=acym_helper.parseJson(t);var e=new Option(t.value,_,!1,!1);a.append(e).trigger("change")})}else a.is(":checkbox")||null!=a.attr("data-switch")?a.is(":checkbox")&&1==_?a.prop("checked",!0):null!=a.attr("data-switch")&&a.val()!=_&&a.closest(".medium-3").find(".cell.switch-label").click():a.val(_);void 0!==a.attr("data-rs")&&""!==_&&(-1!=_.indexOf("]")?t('input[data-open="'+a.attr("data-rs")+'"]').val(_):t('input[data-open="'+a.attr("data-rs")+'"]').val(moment.unix(_).format("DD MMM YYYY HH:mm")))}function s(){1==t("#adminAutomation").val()&&t(document).find('[data-open*="acy_add_queuetime"]').attr("disabled","disabled"),acym_helperDatePicker.setDatePickerGlobal(),acym_helperDatePicker.setRSDateChoice(),function(){var a=t("#acym__automation__actions__json");if(!a.length)return;var _=JSON.parse(a.val());t(".acym__automation__actions__select").off("change.loadoptions").on("change.loadoptions",function(){t(this).parent().parent().find(".acym__automation__inserted__action").remove();var a=_[t(this).val()].option.replace(/__and__/g,t(this).closest(".acym__automation__actions__one__action").attr("data-action-number"));t(this).parent().after('<div class="grid-x acym__automation__inserted__action margin-top-1 margin-left-2 grid-margin-x cell acym_vcenter">'+a+"</div>"),1==t("#adminAutomation").val()&&t(this).parent().next().find('[data-open*="acy_add_queuetime"]').attr("disabled","disabled"),acym_helperSelect2.setSelect2(),t(document).foundation(),t(".reveal-overlay").appendTo("#acym_form"),s();var e=t(this).closest(".acym__automation__actions__one__action").find(".acym__automation__actions__operator__dropdown"),i=t(this).closest(".acym__automation__actions__one__action").find(".acym__automation__actions__fields__dropdown");e.on("change",function(){i.trigger("change")}),i.on("change",function(){var a=t(this).closest(".acym__automation__inserted__action"),_=a.find('[data-action-field="'+t(this).val()+'"]'),i=a.find(".acym__automation__actions__fields__select"),o=a.find(".acym__automation__action__regular-field");_.length>0&&"="===e.val()?(o.attr("name",o.attr("name").replace("acym_action","")).hide(),i.each(function(a){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),-1===_.attr("name").indexOf("acym_action")&&_.attr("name","acym_action"+_.attr("name")),_.closest(".acym__automation__one-field").show()):(-1===o.attr("name").indexOf("acym_action")&&o.attr("name","acym_action"+o.attr("name")),i.length>0&&i.each(function(){t(this).attr("name",t(this).attr("name").replace("acym_action","")),t(this).closest(".acym__automation__one-field").hide()}),o.show())}),t(this).closest(".acym__automation__actions__one__action").find(".acym__automation__actions__fields__dropdown").trigger("change")})}(),t(".acym__automation__add-action").off("click").on("click",function(){var a=t("#acym__automation__action__number__action");a.val(parseInt(a.val())+1),t(this).before(t("#acym__automation__example").html());var _=t(this).prev();_.closest(".acym__automation__actions__one__action").attr("data-action-number",a.val()),_.find("select").select2({theme:"foundation",width:"100%"}),s()}),t(".acym__automation__delete__one__action").off("click").on("click",function(){t(this).closest(".acym__automation__actions__one__action").remove()}),acym_helper.setSubmitButtonGlobal(),t(".acym__automation__actions__mails__select").on("change",function(){"0"!==t(this).val()?t(this).closest(".acym__automation__inserted__action").find('[data-task="createMail"]').html(ACYM_JS_TXT.ACYM_EDIT_MAIL):t(this).closest(".acym__automation__inserted__action").find('[data-task="createMail"]').html(ACYM_JS_TXT.ACYM_CREATE_MAIL)}),acym_helperModal.setResetMail(),acym_helperModal.setTemplateModal(!0)}function d(a){var _=a.attr("data-filter-number"),e=a.find(".acym__automation__or__total__result"),i=ACYM_AJAX_URL+"&page=acymailing_automation&ctrl=automation&task=countResultsOrTotal&or="+_;e.html('<i class="acymicon-circle-o-notch acymicon-spin"></i>'),t.get(i,a.closest("#acym_form").serialize()+"&page=acymailing_automation&ctrl=automation&task=countResultsOrTotal&or="+_).done(function(t){e.html(t)}).fail(function(){e.html(ACYM_JS_TXT.ACYM_ERROR)})}t.reloadCounters=function(_){let e=t(_).closest(".acym__automation__group__filter").attr("data-filter-number"),i=t(_).closest(".acym__automation__group__filter"),o=t(_).closest(".acym__automation__inserted__filter").attr("data-and"),n=ACYM_AJAX_URL+"&page=acymailing_automation&ctrl=automation&task=countresults&or="+e+"&and="+o;void 0!==a[o]&&a[o].abort(),t("#results_"+o).css("maxHeight","18px").html('<i class="acymicon-circle-o-notch acymicon-spin"></i>'),a[o]=t.get(n,t(_).closest("#acym_form").serialize()+"&page=acymailing_automation&ctrl=automation&task=countresults&or="+e+"&and="+o).done(function(a){t("#results_"+o).css("maxHeight","").html(a)}).fail(function(){t("#results_"+o).css("maxHeight","").html(ACYM_JS_TXT.ACYM_ERROR)}),d(i)},t("#acym__automation__info__desc__button").off("click").on("click",function(){var a=t('[name="automation[description]"]');a.is(":visible")?(a.hide(),t(this).find("i").removeClass("acymicon-keyboard_arrow_up").addClass("acymicon-keyboard_arrow_down")):(a.show(),t(this).find("i").removeClass("acymicon-keyboard_arrow_down").addClass("acymicon-keyboard_arrow_up"))}),t("#acym__automation__info__choose__trigger__type p").off("click").on("click",function(){t("#acym__automation__trigger__type__input").val(t(this).attr("data-trigger-type")),t(".selected-trigger").removeClass("selected-trigger"),t(this).addClass("selected-trigger"),t(".acym__automation__info__choose__trigger").hide(),t("#acym__automation__info__choose__trigger__"+t(this).attr("data-trigger-type")).show()}),_("classic"),i("classic"),e("classic"),_("action"),i("action"),e("action"),d(t(".acym__automation__select__classic__filter").closest(".acym__automation__group__filter")),c(),function(){var a=t("#conditions");if(a.length){var _=JSON.parse(a.val()),e=_.type_condition,i=0;t.each(_,function(a,_){var o=0;if("type_condition"==a)return!0;0!=i&&t('.acym__automation__conditions__or[data-condition-type="'+e+'"]').click(),t.each(_,function(a,_){0!=o&&t('.acym__automation__group__condition[data-condition-number="'+i+'"]').find('.acym__automation__add-condition[data-condition-type="'+e+'"]').click(),t.each(_,function(a,_){var o=t('.acym__automation__group__condition[data-condition-number="'+i+'"]').find(".acym__automation__select__"+e+"__condition").last();o.val(a),o.trigger("change");let n=Object.keys(_);t.each(n,function(e){let o=n[e],c=_[n[e]];var r=t('[name="acym_condition[conditions]['+i+"]["+t("#acym__automation__conditions__count__and").val()+"]["+a+"]["+o+']"]');l(r,c),r.trigger("change")})}),o++}),i++}),c()}}(),r(),function(){let a=t("#filters");if(!a.length)return;let _=JSON.parse(a.val()),e=_.type_filter,i=0;t.each(_,function(a,_){let o=0;if("type_filter"==a)return!0;0!=i&&t('.acym__automation__filters__or[data-filter-type="'+e+'"]').click(),t.each(_,function(a,_){0!=o&&t('.acym__automation__group__filter[data-filter-number="'+i+'"]').find('.acym__automation__add-filter[data-filter-type="'+e+'"]').click(),t.each(_,function(a,_){let o=t('.acym__automation__group__filter[data-filter-number="'+i+'"]').find(".acym__automation__select__"+e+"__filter").last();o.val(a),o.trigger("change");let n=Object.keys(_);t.each(n,function(e){let o=n[e],c=_[n[e]],r=t('[name="acym_action[filters]['+i+"]["+t("#acym__automation__filters__count__and").val()+"]["+a+"]["+o+']"]');l(r,c),r.trigger("change")})}),o++}),i++}),r()}(),s(),function(){var a=t("#actions");if(a.length){var _=JSON.parse(a.val()),e=0;t.each(_,function(a,_){e>0&&t(".acym__automation__add-action").click(),t.each(_,function(a,_){var i=t(".acym__automation__actions__select").last();i.val(a),i.trigger("change");let o=Object.keys(_);t.each(o,function(i){let n=o[i],c=_[o[i]];var r=t('[name="acym_action[actions]['+e+"]["+a+"]["+n+']"]');l(r,c),"acy_add_queue"===a&&"mail_id"===n&&""!==c&&(r.next().html(_.mail_name+'<i class="cursor-pointer acymicon-close acym__color__red acym__automation__action__reset__mail margin-left-1"></i>'),r.prev().html(ACYM_JS_TXT.ACYM_EDIT_MAIL)),r.trigger("change")})}),e++}),s()}}()});